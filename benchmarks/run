#!/bin/bash

set -e

export FARM_DIR

BASE_DIR="$(dirname "$(realpath "$0")")"
cd "$BASE_DIR" || exit 1

FARM_DIR="$(mktemp -d)"
export PATH="$BASE_DIR/../target/release:$PATH"

mkdir results 2>/dev/null || :

if [ ! -f "$BASE_DIR/../target/release/farm" ]; then
  echo "Can't access the release version of farm"
  exit 1
fi

if ! command -v hyperfine >/dev/null 2>&1; then
  echo "Can't access Hyperfine. Are you sure it is installed?"
  echo "  if not, visit https://github.com/sharkdp/hyperfine"
  exit 1
fi

chmod +x ./farm
chmod +x ./rbenv

hyperfine \
  --warmup=2 \
  --min-runs=5 \
  --time-unit=millisecond \
  --export-json="./results/basic.json" \
  --export-markdown="./results/basic.md" \
  --show-output \
  "./farm" \
  "./rbenv"
